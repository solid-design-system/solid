name: Quality Gate

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs: 
    quality-gate:
        name: Install, verify and build
        runs-on: ubuntu-latest
        if: github.event.pull_request.draft == false
        container:
            image: mcr.microsoft.com/playwright:v1.43.1-jammy
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Install Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 18

            - uses: pnpm/action-setup@v2
              name: Install pnpm
              id: pnpm-install
              with:
                  version: 8.6.2
                  run_install: false

            - name: Install dependencies
              run: pnpm i

            - name: (monorepo) verify
              run: pnpm verify

    # Check Chromatic for visual changes after all other checks have passed
    chromatic-deployment-pr:
        name: Verify Chromatic
        needs: [quality-gate]
        if: ${{!contains(github.event.pull_request.title, '[skip chromatic]')}}
        runs-on: ubuntu-latest
        steps:
            # ðŸ‘‡ Version 2 of the action
          - name: Checkout repository
            uses: actions/checkout@v4
            with:
              fetch-depth: 0 # ðŸ‘ˆ Required to retrieve git history
          - uses: pnpm/action-setup@v2
            with:
              version: 8.6.2
          # ðŸ‘‡ Install dependencies with the same package manager used in the project (replace it as needed), e.g. yarn, npm, pnpm
          - name: Install dependencies
            run: PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=true pnpm i
          # ðŸ‘‡ Build storybook with pnpm
          - name: Build storybook
            run: cd packages/components && pnpm run build.chromatic
          # ðŸ‘‡ Adds Chromatic as a step in the workflow
          - name: Publish to Chromatic
            uses: chromaui/action@latest
            # Options required to the GitHub Chromatic Action
            with:
              # ðŸ‘‡ Chromatic projectToken, refer to the manage page to obtain it.
              projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
              # Speedup the build by not waiting until everything is sent to Chromatic
              exitOnceUploaded: true
              # TurboSnap is an advanced Chromatic feature that speeds up builds for faster UI testing and review using Git and Webpackâ€™s dependency graph
              onlyChanged: false
              # We need to manually build storybook with pnpm
              storybookBuildDir: packages/components/dist/storybook
