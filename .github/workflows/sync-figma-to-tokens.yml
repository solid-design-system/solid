name: Sync Figma variables to tokens

on:
  push:
    branches: [ "main", "develop", "next", "feat/**"]
  workflow_dispatch:

jobs:
  sync-figma-to-tokens:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set environment variables
        run: |
          # Set FIGMA_FILE_ID
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.figma_file_id }}" != "" ]]; then
            echo "FIGMA_FILE_ID=${{ github.event.inputs.figma_file_id }}" >> $GITHUB_ENV
          else
            echo "FIGMA_FILE_ID=${{ vars.FIGMA_FILE_ID }}" >> $GITHUB_ENV
          fi
         
          # Set BRANCH_NAME and PR_TITLE based on trigger type
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "BRANCH_NAME=${{ github.event.inputs.branch_name }}" >> $GITHUB_ENV
            echo "PR_TITLE=${{ github.event.inputs.pull_request_name }}" >> $GITHUB_ENV
          else
            echo "BRANCH_NAME=feat/update-tokens-from-figma-auto" >> $GITHUB_ENV
            echo "PR_TITLE=feat: ✨ Update tokens from Figma (auto-sync)" >> $GITHUB_ENV
          fi

      - name: Validate environment variables
        run: |
          if [ -z "$FIGMA_FILE_ID" ]; then
            echo "❌ FIGMA_FILE_ID is required. Please either:"
            echo "   1. Set the FIGMA_FILE_ID repository variable in Settings → Secrets and variables → Actions → Variables"
            echo "   2. Provide figma_file_id as input when running manually"
            exit 1
          fi
          if [ -z "$BRANCH_NAME" ]; then
            echo "❌ BRANCH_NAME is empty"
            exit 1
          fi
          echo "✅ Using Figma File ID: $FIGMA_FILE_ID"
          echo "✅ Using Branch Name: $BRANCH_NAME"
          echo "✅ Using PR Title: $PR_TITLE"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=true pnpm i

      - name: Fetch variables from Figma
        run: pnpm -C ./packages/tokens fetch:figma
        env:
          FIGMA_FILE_ID: ${{ env.FIGMA_FILE_ID }}
          FIGMA_TOKEN: ${{ secrets.FIGMA_TOKEN }}

      - name: Run existing build process
        run: pnpm -C ./packages/tokens build

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.PAT_TOKEN_BLAGOJA }}
          commit-message: Update variables and styles from Figma
          title: ${{ env.PR_TITLE }}
          body: |
            Update tokens from Figma for figma file/branch id: ${{ env.FIGMA_FILE_ID }}
           
            Triggered by: ${{ github.event_name }}
            ${{ github.event_name == 'push' && format('Push to branch: {0}', github.ref_name) || '' }}
          branch: ${{ env.BRANCH_NAME }}
          reviewers: |
            smfonseca
            auroraVasconcelos
            paulovareiro29
            mariohamann
            balco0110