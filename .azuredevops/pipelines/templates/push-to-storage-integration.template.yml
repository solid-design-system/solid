steps:
  ## Deploy folder to CDN
  - task: AzureCLI@2
    displayName: 'Deploying to Azure Blob Storage'
    inputs:
      azureSubscription: 'Workload CI/CD Service Connection (S_STATICCONTENT_PROD)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      version=$(npm --no-git-tag-version version)
      versionArray=($(echo "$version" | tr '.' ' '))

      # Deploy to version folder
      set -x
      echo "Target folder is $(version)"
      az storage blob upload-batch \
        --destination \$web \
        --account-name "safesoliddesignsystemprod" \
        --source dist \
        --destination-path "/$(version)" \
        --overwrite
      set +x

      # Deploy to latest folder
      set -x
      echo "Target folder is x.x.x"
      az storage blob upload-batch \
        --destination \$web \
        --account-name "safesoliddesignsystemprod" \
        --source dist \
        --destination-path "/x.x.x" \
        --overwrite
      set +x

      # Deploy to patch wildcard folder
      set -x
      echo "Target folder is $(versionArray[0]).$(versionArray[1]).x"
      az storage blob upload-batch \
        --destination \$web \
        --account-name "safesoliddesignsystemprod" \
        --source dist \
        --destination-path "/$(versionArray[0]).$(versionArray[1]).x" \
        --overwrite
      set +x

      # Deploy to minor wildcard folder
      set -x
      echo "Target folder is $(versionArray[0]).x.x"
      az storage blob upload-batch \
        --destination \$web \
        --account-name "safesoliddesignsystemprod" \
        --source dist \
        --destination-path "/$(versionArray[0]).x.x" \
        --overwrite
      set +x

  ## Purge CDN for all folders
  - template: .azuredevops/pipelines/templates/purge-cdn.template.yml
    parameters:
      destinationPath: '$(version)'

  - template: .azuredevops/pipelines/templates/purge-cdn.template.yml
    parameters:
      destinationPath: 'x.x.x'

  - template: .azuredevops/pipelines/templates/purge-cdn.template.yml
    parameters:
      destinationPath: '$(versionArray[0]).$(versionArray[1]).x'

  - template: .azuredevops/pipelines/templates/purge-cdn.template.yml
    parameters:
      destinationPath: '$(versionArray[0]).x.x'
